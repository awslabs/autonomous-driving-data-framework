AWSTemplateFormatVersion: 2010-09-09
Description: This stack deploys a Module specific IAM permissions

Parameters:
  # DeploymentName:
  #   Type: String
  #   Description: The name of the deployment
  # ModuleName:
  #   Type: String
  #   Description: The name of the Module
  RoleName:
    Type: String
    Description: The name of the IAM Role
  EksClusterAdminRoleArn:
    Type: String
    Description: Role from the EKS module with cluster admin permissions

Resources:
  Policy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - "sts:AssumeRole"
            Resource:
              - !Ref EksClusterAdminRoleArn
          - Effect: Allow
            Action:
            # List/Describe permissions require wildcard - no resource-level support
              - "emr-containers:List*"
              - "emr-containers:Describe*"
              - "elasticmapreduce:Describe*"
              - "elasticmapreduce:List*"
              - "sso:DeleteManagedApplicationInstance"
            Resource:
              - "*"
          - Effect: Allow
            Action:
            # Delete permissions scoped to specific resources
              - "emr-containers:DeleteVirtualCluster"
              - "emr-containers:DeleteManagedEndpoint"
              - "elasticmapreduce:DeleteStudio"
            Resource:
              - !Sub "arn:aws:emr-containers:${AWS::Region}:${AWS::AccountId}:virtualcluster/*"
              - !Sub "arn:aws:elasticmapreduce:${AWS::Region}:${AWS::AccountId}:studio/*"
          - Effect: Allow
            Action:
              - "ec2:RevokeSecurityGroupEgress"
              - "ec2:CreateSecurityGroup"
              - "ec2:DeleteSecurityGroup"
              - "ec2:AuthorizeSecurityGroupEgress"
              - "ec2:AuthorizeSecurityGroupIngress"
              - "ec2:RevokeSecurityGroupIngress"
            Resource:
              - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*"
              - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc/*"
          - Action:
              - "iam:CreateServiceLinkedRole"
            Effect: Allow
            Resource:
              - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/*.amazonaws.com/*"
          # Wildcard use on the specfic resources created by SeedFarmer
        Version: 2012-10-17
      PolicyName: "addf-modulespecific-policy"
      Roles: [!Ref RoleName]